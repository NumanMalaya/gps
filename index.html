<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Malaya GPS Overlay</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }

    input,
    select,
    button {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
    }

    .preview-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .capture {
      width: 400px;
      position: relative;
      background: white;
      overflow: hidden;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(28, 27, 27, 0.2);
    }

    .main-photo {
      width: 400px;
      height: 500px;
      object-fit: fill;
      display: block;
      background-color: white;
    }

    .gps-footer {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 380px;
      background-color: rgba(44, 44, 44, 0.85);
      color: white;
      display: flex;
      align-items: flex-start;
      padding: 8px 8px 8px 0px;
      font-size: 11px;
      box-sizing: border-box;
    }

    .map-thumbnail {
      width: 80px;
      height: 55px;
      object-fit: contain;
      margin-right: 5px;
    }

    .gps-details {
      flex-grow: 1;
      line-height: 1.3;
      text-align: left;
      width: 100px;
    }

    .gps-details b {
      font-family: Georgia, serif;
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }

    .gps-logo {
      display: flex;
      align-items: center;
      font-size: 10px;
      font-family: Arial, sans-serif;
      margin-left: 6px;
      margin-top: 4px;
    }

    .gps-logo-icon {
      width: 20px;
      height: 20px;
      margin-right: 4px;
    }

    .download-btn {
      margin-top: 15px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
    }

    .download-btn:hover {
      background-color: #0056b3;
    }

    /* Progress Bar */
    .progress-container {
      width: 80%;
      max-width: 400px;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      margin: 20px auto;
      display: none;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #007bff, #00d4ff);
      transition: width 0.3s ease;
    }

    .progress-text {
      margin-top: 5px;
      font-size: 13px;
    }
  </style>
</head>

<body>

  <h2>Malaya GPS Overlay</h2>

  <div class="form-container">
    <input type="file" id="imageUpload" accept="image/*" multiple />
    <br />
    <input type="text" id="city" placeholder="City (e.g. Ārifwāla)" />
    <input type="text" id="address" placeholder="Address" />
    <br />
    <input type="text" id="latitude" placeholder="Latitude (e.g. 30.297783)" />
    <input type="text" id="longitude" placeholder="Longitude (e.g. 73.057033)" />
    <select id="fixedDigits">
      <option value="1">1 digit fixed</option>
      <option value="2">2 digits fixed</option>
      <option value="3">3 digits fixed</option>
      <option value="4" selected>4 digits fixed (default)</option>
    </select>
    <br />

    <!-- Date Options -->
    <input type="text" id="date" placeholder="DD/MM/YYYY" maxlength="10" />
    <select id="dateMode">
      <option value="fixed" selected>Same Date</option>
      <option value="consecutive">Consecutive Dates</option>
    </select>
    <br />

    <input type="text" id="time" placeholder="HH:MM" maxlength="5" />
    <select id="ampm">
      <option value="AM">AM</option>
      <option value="PM">PM</option>
    </select>
  </div>

  <button class="download-btn" onclick="downloadAll()">Download</button>

  <!-- Progress Bar -->
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="progress-text" id="progressText"></div>

  <div class="preview-container" id="previewContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    let imagesData = [];

    document.getElementById("imageUpload").addEventListener("change", handleFiles);

    function handleFiles(event) {
      const files = event.target.files;
      if (!files.length) return;
      imagesData = [];
      document.getElementById("previewContainer").innerHTML = "";

      // ✅ Reset progress
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      progressContainer.style.display = "none";
      progressBar.style.width = "0%";
      progressText.innerText = "";

      Array.from(files).forEach((file) => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const container = document.createElement("div");
          container.className = "capture";
          container.innerHTML = `
            <img src="${e.target.result}" class="main-photo" />
            <div class="gps-footer">
              <img src="data/icon2.png" alt="Map" class="map-thumbnail" />
              <div class="gps-details">
                <b class="gps-location"></b>
                <span class="gps-pluscode"></span>
                <span class="gps-address"></span><br />
                Lat <span class="gps-lat"></span>° Long <span class="gps-lng"></span>°<br />
                <span class="gps-datetime"></span>
              </div>
              <div class="gps-logo">
                <img src="data/icon3.png" alt="GPS Icon" class="gps-logo-icon" />
                <span>GPS Smart</span>
              </div>
            </div>
          `;
          document.getElementById("previewContainer").appendChild(container);
          imagesData.push(container);
          updateOverlay();
        };
        reader.readAsDataURL(file);
      });
    }

    function randomizeCoord(coord) {
      let [intPart, decPart] = coord.split(".");
      if (!decPart) decPart = "000000";
      let fixedCount = parseInt(document.getElementById("fixedDigits").value) || 4;
      if (fixedCount > decPart.length) fixedCount = decPart.length;
      let fixed = decPart.slice(0, fixedCount);
      let remaining = decPart.length - fixedCount;
      let rand = Math.floor(Math.random() * Math.pow(10, remaining));
      let randStr = String(rand).padStart(remaining, "0");
      return intPart + "." + fixed + randStr;
    }

    function generatePlusCode() {
      const consonants = "bcdfghjklmnpqrstvwxyz";
      const randDigit = (len) =>
        String(Math.floor(Math.random() * Math.pow(10, len))).padStart(len, "0");
      const randConsonant = () =>
        consonants[Math.floor(Math.random() * consonants.length)];
      const part1 = randDigit(3);
      const part2 = randConsonant();
      const part3 = randDigit(1);
      const part4 = randConsonant() + randConsonant();
      return `${part1}${part2} + ${part3}${part4}`;
    }

    function randomizeTime() {
      let start = 8 * 60, end = 16 * 60;
      let randMinutes = Math.floor(Math.random() * (end - start + 1)) + start;
      let hour24 = Math.floor(randMinutes / 60);
      let minute = randMinutes % 60;
      let ampm = hour24 >= 12 ? "PM" : "AM";
      let hour12 = hour24 % 12;
      if (hour12 === 0) hour12 = 12;
      return `${hour12}:${String(minute).padStart(2, "0")} ${ampm}`;
    }

    function formatTimeWithAMPM(timeVal, ampmVal) {
      if (!timeVal) return randomizeTime();
      let [h, m] = timeVal.split(":");
      let hour = parseInt(h, 10);
      let minute = parseInt(m, 10);
      if (isNaN(hour) || isNaN(minute)) return randomizeTime();
      return `${hour}:${String(minute).padStart(2, "0")} ${ampmVal}`;
    }

    function getTodayDate() {
      const today = new Date();
      let dd = String(today.getDate()).padStart(2, '0');
      let mm = String(today.getMonth() + 1).padStart(2, '0');
      let yyyy = today.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }

    function addDaysSkippingSundays(baseDate, imagesCount) {
      const [dd, mm, yyyy] = baseDate.split("/").map(Number);
      let dateObj = new Date(yyyy, mm - 1, dd);
      let dates = [];
      while (dates.length < imagesCount) {
        let day = dateObj.getDay(); // 0 = Sunday
        if (!(dates.length > 0 && day === 0)) {
          dates.push(
            `${String(dateObj.getDate()).padStart(2, "0")}/${String(dateObj.getMonth() + 1).padStart(2, "0")}/${dateObj.getFullYear()}`
          );
        }
        dateObj.setDate(dateObj.getDate() + 1);
      }
      return dates;
    }

    function updateOverlay() {
      const city = document.getElementById('city').value.trim() || 'Ārifwāla';
      const address = document.getElementById('address').value.trim() || '';
      const baseLat = document.getElementById('latitude').value.trim() || '30.297293';
      const baseLng = document.getElementById('longitude').value.trim() || '73.066914';

      const dateInput = document.getElementById('date').value.trim();
      const baseDate = dateInput || getTodayDate();
      const dateMode = document.getElementById('dateMode').value;

      const manualTime = document.getElementById('time').value;
      const ampm = document.getElementById('ampm').value;

      let consecutiveDates = [];
      if (dateMode === "consecutive") {
        consecutiveDates = addDaysSkippingSundays(baseDate, imagesData.length);
      }

      imagesData.forEach((container, index) => {
        let lat, lng, timeStr, plusCode, dateStr;

        if (index === 0) {
          lat = baseLat;
          lng = baseLng;
          timeStr = formatTimeWithAMPM(manualTime, ampm);
        } else {
          lat = randomizeCoord(baseLat);
          lng = randomizeCoord(baseLng);
          timeStr = randomizeTime();
        }

        if (dateMode === "fixed") {
          dateStr = baseDate;
        } else {
          dateStr = consecutiveDates[index];
        }

        plusCode = generatePlusCode();

        container.querySelector(".gps-location").innerText = `${city}, Punjab, Pakistan`;
        container.querySelector(".gps-pluscode").innerText = plusCode;
        container.querySelector(".gps-address").innerText = `${address}, ${city}, Punjab, Pakistan`;
        container.querySelector(".gps-lat").innerText = lat;
        container.querySelector(".gps-lng").innerText = lng;
        container.querySelector(".gps-datetime").innerText = `${dateStr} ${timeStr} GMT +05:00`;
      });
    }

    const fields = ['city', 'address', 'latitude', 'longitude', 'date', 'time', 'ampm', 'fixedDigits', 'dateMode'];
    fields.forEach(id => {
      document.getElementById(id).addEventListener('input', updateOverlay);
      document.getElementById(id).addEventListener('change', updateOverlay);
    });

    // ✅ Optimized Sequential Download with batching
    async function downloadAll() {
      let totalImages = imagesData.length;
      if (totalImages === 0) {
        alert("No images to download!");
        return;
      }

      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");

      progressContainer.style.display = "block";
      progressBar.style.width = "0%";
      progressText.innerText = "Starting...";

      // Single image case
      if (totalImages === 1) {
        const canvas = await html2canvas(imagesData[0], { useCORS: true, scale: 1 });
        canvas.toBlob((blob) => {
          saveAs(blob, "gps-image-1.png");
          progressBar.style.width = "100%";
          progressText.innerText = "Download complete!";
        }, "image/png");
        return;
      }

      // Multiple → batch into chunks
      const batchSize = 50;
      let zipIndex = 1;

      for (let start = 0; start < totalImages; start += batchSize) {
        let zip = new JSZip();
        const end = Math.min(start + batchSize, totalImages);

        for (let i = start; i < end; i++) {
          progressText.innerText = `Processing ${i + 1}/${totalImages}...`;

          const canvas = await html2canvas(imagesData[i], { useCORS: true, scale: 1 });

          await new Promise((resolve) => {
            canvas.toBlob((blob) => {
              zip.file(`gps-image-${i + 1}.png`, blob, { binary: true });
              let percent = Math.round(((i + 1) / totalImages) * 100);
              progressBar.style.width = percent + "%";
              resolve();
            }, "image/png");
          });
        }

        progressText.innerText = `Finalizing ZIP ${zipIndex}...`;
        const content = await zip.generateAsync({
          type: "blob",
          compression: "STORE" // 🚀 Faster, no compression
        });
        saveAs(content, `gps-images-part${zipIndex}.zip`);
        zipIndex++;
      }

      progressBar.style.width = "100%";
      progressText.innerText = "All downloads complete!";
    }
  </script>
</body>
</html>
